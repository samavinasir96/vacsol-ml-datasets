<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VacSol ML Datasets — Explorer</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#9aa7bf;
  --accent:#6ee7b7;
  --glass:rgba(255,255,255,0.03);
}
html,body{
  margin:0;height:100%;
  font-family:Inter,system-ui;
  background:linear-gradient(180deg,#071227,#08182a);
  color:#dce9f6;
}
.wrap{display:flex;gap:20px;padding:24px}
.sidebar{width:280px;background:var(--card);border-radius:12px;padding:18px;position:sticky;top:24px;height:fit-content}
.main{flex:1}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
  border-radius:12px;padding:16px;margin-bottom:16px}

h1,h2{margin:0 0 8px}
h1{font-size:18px}
h2{font-size:15px}

label{font-size:13px;color:var(--muted)}
select,input{
  width:100%;padding:8px;border-radius:8px;
  background:var(--glass);border:1px solid rgba(255,255,255,0.05);
  color:#fff;margin-top:6px
}

.btn{display:inline-block;margin-top:10px;padding:8px 10px;
  border-radius:8px;background:var(--glass);color:var(--accent);
  text-decoration:none;font-size:13px}

.chart-box{height:240px;position:relative}
.chart-box.small{height:200px}
.chart-box canvas{width:100%!important;height:100%!important}

#heatmap{
  max-height:420px;
  overflow:auto;
  margin-top:10px;
}

footer{font-size:12px;color:var(--muted);text-align:center}
</style>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
<div class="wrap">

<!-- SIDEBAR -->
<aside class="sidebar">
  <h1>VacSol ML Datasets</h1>
  <p style="font-size:13px;color:var(--muted)">
    Fast interactive explorer (optimized)
  </p>

  <label>Dataset</label>
  <select id="datasetSelect">
    <option value="dataset1">VacSol-ML Dataset</option>
    <option value="dataset2">VacSol-ML Dataset (Original)</option>
  </select>

  <label style="margin-top:12px">Feature Group</label>
  <select id="groupSelect">
    <option value="auto">Auto</option>
    <option value="physicochemical">Physicochemical</option>
    <option value="immunogenicity">Immunogenicity</option>
    <option value="timeseries">Time-series</option>
    <option value="all">All numeric</option>
  </select>

  <a id="downloadBtn" class="btn" target="_blank">Download CSV</a>
</aside>

<!-- MAIN -->
<main class="main">

<div class="card">
  <h2>Organism Distribution</h2>
  <div class="chart-box small">
    <canvas id="organismChart"></canvas>
  </div>
</div>

<div class="card">
  <h2>Top Features (Variance)</h2>
  <div class="chart-box">
    <canvas id="groupBar"></canvas>
  </div>
</div>

<div class="card">
  <h2>Feature Distribution</h2>
  <select id="featureSelect"></select>
  <div class="chart-box small">
    <canvas id="histChart"></canvas>
  </div>
</div>

<div class="card">
  <h2>Correlation Heatmap (Top 12)</h2>
  <div id="heatmap"></div>
</div>

<footer class="card">
  Built for VacSol-ML · Optimized for GitHub Pages
</footer>

</main>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const MAX_HEATMAP = 12;
const FILES = {
  dataset1:"https://raw.githubusercontent.com/samavinasir96/vacsol-ml-datasets/main/VacSol-ML%20Dataset.csv",
  dataset2:"https://raw.githubusercontent.com/samavinasir96/vacsol-ml-datasets/main/VacSol-ML_DataSet_new_original.csv"
};

/* ---------------- STATE ---------------- */
const rawData = {};
const cache = {numeric:{},stats:{}};
let charts = {};
let currentDataset = "dataset1";

/* ---------------- UTIL ---------------- */
function parseNum(v){
  const n = parseFloat(String(v||"").replace(/[, ]+/g,''));
  return Number.isFinite(n)?n:null;
}

/* ---------------- LOAD CSV (LAZY) ---------------- */
function loadDataset(key){
  if(rawData[key]) return Promise.resolve(rawData[key]);

  return new Promise(res=>{
    Papa.parse(FILES[key],{
      download:true,
      header:true,
      skipEmptyLines:true,
      complete:r=>{
        rawData[key]=r.data;
        res(r.data);
      }
    });
  });
}

/* ---------------- NUMERIC DETECT (CACHED) ---------------- */
function numericCols(key,rows){
  if(cache.numeric[key]) return cache.numeric[key];
  const cols=Object.keys(rows[0]);
  const nums=cols.filter(c=>rows.slice(0,50).filter(r=>parseNum(r[c])!==null).length>25);
  cache.numeric[key]=nums;
  return nums;
}

/* ---------------- STATS (CACHED) ---------------- */
function statsFor(key,rows,cols){
  const sig=key+cols.join("|");
  if(cache.stats[sig]) return cache.stats[sig];
  const s=cols.map(c=>{
    const v=rows.map(r=>parseNum(r[c])).filter(x=>x!==null);
    if(v.length<2) return null;
    const m=v.reduce((a,b)=>a+b,0)/v.length;
    const sd=Math.sqrt(v.reduce((a,b)=>a+(b-m)**2,0)/(v.length-1));
    return {c,sd};
  }).filter(Boolean);
  cache.stats[sig]=s;
  return s;
}

/* ---------------- CHARTS ---------------- */
function barChart(ctx,labels,data){
  if(charts[ctx]) charts[ctx].destroy();
  charts[ctx]=new Chart(document.getElementById(ctx),{
    type:"bar",
    data:{labels,datasets:[{data,backgroundColor:"#6ee7b7"}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}
  });
}

/* ---------------- HEATMAP (LAZY) ---------------- */
let heatmapRendered=false;
function renderHeatmap(rows,cols){
  if(heatmapRendered) return;
  heatmapRendered=true;
  cols=cols.slice(0,MAX_HEATMAP);

  const data=cols.map(a=>cols.map(b=>{
    const x=[],y=[];
    rows.forEach(r=>{
      const va=parseNum(r[a]), vb=parseNum(r[b]);
      if(va!==null&&vb!==null){x.push(va);y.push(vb);}
    });
    if(x.length<2) return 0;
    const ma=x.reduce((s,v)=>s+v,0)/x.length;
    const mb=y.reduce((s,v)=>s+v,0)/y.length;
    let num=0,da=0,db=0;
    for(let i=0;i<x.length;i++){
      num+=(x[i]-ma)*(y[i]-mb);
      da+=(x[i]-ma)**2; db+=(y[i]-mb)**2;
    }
    return num/Math.sqrt(da*db||1);
  }));

  const size=cols.length*18;
  const svg=d3.select("#heatmap").append("svg")
    .attr("width",size+120).attr("height",size+120);

  const g=svg.append("g").attr("transform","translate(100,20)");
  const color=d3.scaleLinear().domain([-1,0,1]).range(["#083344","#1e3a8a","#2dd4bf"]);

  g.selectAll("g").data(data).enter().append("g")
    .attr("transform",(d,i)=>`translate(0,${i*18})`)
    .selectAll("rect").data(d=>d).enter().append("rect")
    .attr("x",(d,i)=>i*18).attr("width",17).attr("height",17)
    .attr("fill",d=>color(d));
}

/* ---------------- INIT ---------------- */
async function init(key){
  currentDataset=key;
  const rows=await loadDataset(key);
  document.getElementById("downloadBtn").href=FILES[key];

  const nums=numericCols(key,rows);
  const s=statsFor(key,rows,nums).sort((a,b)=>b.sd-a.sd);
  const top=s.slice(0,10);

  barChart("groupBar",top.map(x=>x.c),top.map(x=>x.sd));

  document.getElementById("featureSelect").innerHTML=
    nums.map(c=>`<option>${c}</option>`).join("");

  renderHeatmap(rows,top.map(x=>x.c));
}

init("dataset1");

document.getElementById("datasetSelect").onchange=e=>{
  heatmapRendered=false;
  document.getElementById("heatmap").innerHTML="";
  init(e.target.value);
};
</script>
</body>
</html>
