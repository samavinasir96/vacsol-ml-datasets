<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VacSol-ML Dataset Explorer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot@4.3.0"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
:root{
  --bg:#0f1724;
  --card:#172036;
  --text:#e5f0ff;
  --muted:#9fb4d8;
  --accent:#4cc9f0;
}

body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

header{
  padding:24px;
  text-align:center;
}

h1{margin:0;font-size:1.8rem}
h2{margin:0 0 8px 0;font-size:1.1rem}

main{
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:16px;
}

.card{
  background:var(--card);
  border-radius:14px;
  padding:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}

.card.full{grid-column:1/-1}

.controls{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:8px;
}

select,input{
  background:#0f1724;
  color:var(--text);
  border:1px solid #223055;
  border-radius:8px;
  padding:6px 10px;
}

.chart-box{
  height:260px;
}
.chart-box.small{height:220px}
.chart-box.large{height:320px}

.chart-box canvas{
  width:100%!important;
  height:100%!important;
}

figure{
  margin:0;
}
figcaption{
  font-size:.75rem;
  color:var(--muted);
  margin-top:6px;
}

/* Heatmap */
#heatmap{
  max-height:420px;
  overflow:auto;
  margin-top:12px;
}

.hm-label.physio{fill:#4cc9f0}
.hm-label.comp{fill:#f8961e}
.hm-label.struct{fill:#90dbf4}

.tooltip{
  position:absolute;
  pointer-events:none;
  background:#000;
  padding:6px 8px;
  font-size:.75rem;
  border-radius:6px;
  opacity:0;
}
</style>
</head>

<body>

<header>
  <h1>VacSol-ML Dataset Interactive Explorer</h1>
  <p style="color:var(--muted)">Exploratory visualization for physicochemical & sequence-derived features</p>
</header>

<main>

<!-- Organism -->
<div class="card">
  <figure>
    <h2>Organism Distribution</h2>
    <div class="chart-box small">
      <canvas id="organismChart"></canvas>
    </div>
    <figcaption id="cap-org"></figcaption>
  </figure>
</div>

<!-- Feature Boxplot -->
<div class="card">
  <figure>
    <h2>Feature Distribution (Boxplot)</h2>
    <div class="controls">
      <select id="boxFeature"></select>
    </div>
    <div class="chart-box">
      <canvas id="boxChart"></canvas>
    </div>
    <figcaption id="cap-box"></figcaption>
  </figure>
</div>

<!-- Feature Search -->
<div class="card">
  <figure>
    <h2>Top Features by Variance</h2>
    <div class="controls">
      <input id="searchFeature" placeholder="Search featureâ€¦">
    </div>
    <div class="chart-box large">
      <canvas id="varChart"></canvas>
    </div>
    <figcaption id="cap-var"></figcaption>
  </figure>
</div>

<!-- Heatmap -->
<div class="card full">
  <figure>
    <h2>Feature Heatmap (Top Variable Features)</h2>
    <div id="heatmap"></div>
    <figcaption id="cap-hm"></figcaption>
  </figure>
</div>

</main>

<div class="tooltip" id="tooltip"></div>

<script>
const DATASET = "dataset.csv";
const MAX_HEATMAP = 15;

const featureTypes = {
  "molecular_weight":"physio",
  "length":"physio",
  "gravy":"physio",
  "aac_A":"comp",
  "aac_G":"comp",
  "helix":"struct"
};

let data, numericCols;

d3.csv(DATASET, d3.autoType).then(d=>{
  data=d;
  numericCols=Object.keys(d[0]).filter(c=>typeof d[0][c]==="number");

  initOrganism();
  initBox();
  initVariance();
  initHeatmap();
});

/* ---------- Organism ---------- */
function initOrganism(){
  const counts=d3.rollup(data,v=>v.length,d=>d.organism);
  const labels=[...counts.keys()];
  const values=[...counts.values()];

  new Chart(organismChart,{
    type:"bar",
    data:{labels,datasets:[{data:values}]},
    options:{
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      datasets:{bar:{barThickness:18}},
    }
  });

  cap("cap-org",
    "Bar chart showing the distribution of protein entries across organisms in the VacSol-ML dataset."
  );
}

/* ---------- Boxplot ---------- */
function initBox(){
  const sel=boxFeature;
  numericCols.forEach(c=>sel.add(new Option(c,c)));
  sel.onchange=drawBox;
  drawBox();
}

let boxChart;
function drawBox(){
  const f=boxFeature.value;
  const vals=data.map(d=>d[f]).filter(v=>v!=null);

  if(boxChart) boxChart.destroy();

  boxChart=new Chart(boxChartEl,{
    type:"boxplot",
    data:{labels:[f],datasets:[{data:[vals]}]},
    options:{maintainAspectRatio:false}
  });

  cap("cap-box",
    `Boxplot summarizing the distribution of ${f}, highlighting median, interquartile range, and outliers.`
  );
}

/* ---------- Variance ---------- */
function initVariance(){
  const stats=numericCols.map(c=>{
    const v=data.map(d=>d[c]);
    return {c,std:d3.deviation(v)};
  }).sort((a,b)=>b.std-a.std).slice(0,12);

  new Chart(varChart,{
    type:"bar",
    data:{
      labels:stats.map(s=>s.c),
      datasets:[{data:stats.map(s=>s.std)}]
    },
    options:{
      indexAxis:"y",
      maintainAspectRatio:false,
      plugins:{
        tooltip:{
          callbacks:{
            label:ctx=>`Std Dev: ${ctx.raw.toFixed(3)}`
          }
        }
      }
    }
  });

  cap("cap-var",
    "Horizontal bar chart ranking features by standard deviation, used as a proxy for variability and potential discriminative power."
  );
}

/* ---------- Heatmap ---------- */
function initHeatmap(){
  const stats=numericCols.map(c=>{
    const v=data.map(d=>d[c]);
    return {c,std:d3.deviation(v)};
  }).sort((a,b)=>b.std-a.std).slice(0,MAX_HEATMAP);

  const cols=stats.map(s=>s.c);
  const rows=data.slice(0,30);

  const cell=18, m={t:80,l:160};
  const w=cell*cols.length+m.l+20;
  const h=cell*rows.length+m.t+20;

  const svg=d3.select("#heatmap")
    .append("svg")
    .attr("width",w)
    .attr("height",h);

  const scale=d3.scaleSequential(d3.interpolateViridis)
    .domain(d3.extent(rows.flatMap(r=>cols.map(c=>r[c]))));

  svg.selectAll("rect")
    .data(rows.flatMap((r,i)=>cols.map(c=>({r,i,c,v:r[c]}))))
    .join("rect")
    .attr("x",d=>m.l+cols.indexOf(d.c)*cell)
    .attr("y",d=>m.t+d.i*cell)
    .attr("width",cell)
    .attr("height",cell)
    .attr("fill",d=>scale(d.v))
    .on("mousemove",(e,d)=>{
      tooltip.style.opacity=1
        .style.left=e.pageX+10+"px"
        .style.top=e.pageY+10+"px"
        .html(`${d.c}<br>${d.v}`);
    })
    .on("mouseout",()=>tooltip.style.opacity=0);

  svg.selectAll("text.col")
    .data(cols)
    .join("text")
    .attr("class",d=>"hm-label "+(featureTypes[d]||"physio"))
    .attr("x",(d,i)=>m.l+i*cell+cell/2)
    .attr("y",m.t-6)
    .attr("transform",(d,i)=>`rotate(-45 ${m.l+i*cell} ${m.t-6})`)
    .text(d=>d);

  cap("cap-hm",
    "Heatmap visualization of the top variable features across representative protein entries. Feature labels are color-coded by feature type (physicochemical, compositional, structural)."
  );
}

/* ---------- Caption helper ---------- */
function cap(id,text){
  document.getElementById(id).innerText="Figure: "+text;
}
</script>

</body>
</html>
