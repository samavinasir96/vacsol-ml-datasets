<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>VacSol-ML Dataset Explorer</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#9aa7bf;
  --accent:#6ee7b7;
  --blue:#60a5fa;
}

html,body{
  margin:0;
  font-family:Inter,system-ui;
  background:linear-gradient(180deg,#071227,#08182a);
  color:#dce9f6;
}

.wrap{
  display:flex;
  gap:20px;
  padding:28px;
}

.card{
  background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
  border:1px solid rgba(255,255,255,0.04);
  border-radius:12px;
  padding:18px;
}

.sidebar{
  width:300px;
  position:sticky;
  top:28px;
  height:calc(100vh - 56px);
  overflow:auto;
}

.main{flex:1}

h1{font-size:18px;margin:0}
h2{font-size:16px;margin-bottom:8px}
.small{font-size:13px;color:var(--muted)}

select,button{
  width:100%;
  padding:9px;
  border-radius:8px;
  background:#0b1220;
  color:#dce9f6;
  border:1px solid rgba(255,255,255,0.05);
}

button{
  cursor:pointer;
  font-weight:600;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}

.full{grid-column:1/-1}

.chart-box{
  height:260px;
  position:relative;
}

.chart-box.small{height:220px}

.chart-box canvas{
  width:100%!important;
  height:100%!important;
}

#heatmap{
  max-height:420px;
  overflow:auto;
}

.legend{
  display:flex;
  gap:14px;
  font-size:12px;
  margin-top:8px;
}

.legend span{
  display:flex;
  align-items:center;
  gap:6px;
}

.legend i{
  width:14px;
  height:14px;
  border-radius:4px;
  display:inline-block;
}

footer{
  text-align:center;
  font-size:13px;
  color:var(--muted);
  margin-top:18px;
}

@media(max-width:900px){
  .wrap{flex-direction:column}
  .sidebar{width:auto;height:auto}
  .grid{grid-template-columns:1fr}
}
</style>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body>
<div class="wrap">

<!-- SIDEBAR -->
<aside class="sidebar card">
  <h1>VacSol-ML Explorer</h1>
  <p class="small">Public interactive visualization of VacSol-ML datasets</p>

  <label class="small">Dataset</label>
  <select id="datasetSelect">
    <option value="dataset1">VacSol-ML Dataset</option>
    <option value="dataset2">VacSol-ML Extended Dataset</option>
  </select>

  <label class="small" style="margin-top:12px">Feature Group</label>
  <select id="groupSelect">
    <option value="physicochemical">Physicochemical</option>
    <option value="immunogenicity">Immunogenicity</option>
    <option value="timeseries">Time-series</option>
    <option value="all">All numeric</option>
  </select>

  <button id="downloadBtn" style="margin-top:12px">⬇ Download CSV</button>
</aside>

<!-- MAIN -->
<main class="main">

<section class="card">
<h2>Dataset overview</h2>

<div class="grid">

<!-- Variance -->
<div class="card">
<h2>Top-variance features</h2>
<div class="chart-box">
<canvas id="varianceChart"></canvas>
</div>
<button onclick="exportChart('varianceChart')">Export PNG</button>
</div>

<!-- Histogram -->
<div class="card">
<h2>Feature distribution</h2>
<div class="chart-box small">
<canvas id="histChart"></canvas>
</div>
<button onclick="exportChart('histChart')">Export PNG</button>
</div>

<!-- Heatmap -->
<div class="card full">
<h2>Correlation heatmap</h2>
<div id="heatmap"></div>

<div class="legend">
<span><i style="background:#002b36"></i> −1</span>
<span><i style="background:#0b3a59"></i> 0</span>
<span><i style="background:#2a7f6e"></i> +1</span>
</div>
</div>

</div>
</section>

<footer class="card">
VacSol-ML Dataset Explorer · Built for public sharing & publication
</footer>

</main>
</div>

<script>
/* ================= CONFIG ================= */
const COMMIT="0b22d317414da667d8224d16f56f36a7216d3a16";
const BASE=`https://raw.githubusercontent.com/samavinasir96/vacsol-ml-datasets/${COMMIT}/`;
const FILES={
 dataset1:BASE+"VacSol-ML%20Dataset.csv",
 dataset2:BASE+"VacSol-ML_DataSet_new_original.csv"
};
const MAX_HEATMAP_FEATURES=15;

/* ================= STATE ================= */
let data={}, charts={};

/* ================= LOAD ================= */
function loadCSV(key){
 return new Promise(res=>{
  Papa.parse(FILES[key],{
   download:true,header:true,skipEmptyLines:true,
   complete:r=>res(r.data)
  });
 });
}

Promise.all([loadCSV("dataset1"),loadCSV("dataset2")]).then(d=>{
 data.dataset1=d[0];
 data.dataset2=d[1];
 renderAll("dataset1");
});

/* ================= UTIL ================= */
function numericCols(rows){
 return Object.keys(rows[0]).filter(c=>rows.every(r=>r[c]===""||!isNaN(r[c])));
}

function groupCols(cols,type){
 const rules={
  physicochemical:/weight|aa|hydropathy|isoelectric|aromatic/i,
  immunogenicity:/mhc|bcell|rank|prob|antigen/i,
  timeseries:/lag|CID/i
 };
 if(type==="all") return cols;
 return cols.filter(c=>rules[type]?.test(c));
}

function variance(vals){
 const m=vals.reduce((a,b)=>a+b,0)/vals.length;
 return vals.reduce((a,b)=>a+(b-m)**2,0)/(vals.length-1);
}

/* ================= RENDER ================= */
function renderAll(key){
 const rows=data[key];
 document.getElementById("downloadBtn").onclick=()=>window.open(FILES[key]);

 const nums=numericCols(rows);
 const group=groupCols(nums,groupSelect.value);
 renderVariance(rows,group);
 renderHistogram(rows,group[0]);
 renderHeatmap(rows,group.slice(0,MAX_HEATMAP_FEATURES));
}

/* ===== VARIANCE BAR ===== */
function renderVariance(rows,cols){
 const stats=cols.map(c=>{
  const v=rows.map(r=>+r[c]).filter(x=>!isNaN(x));
  return {c,var:variance(v)};
 }).sort((a,b)=>b.var-a.var).slice(0,10);

 if(charts.var)charts.var.destroy();
 charts.var=new Chart(varianceChart,{
  type:"bar",
  data:{labels:stats.map(s=>s.c),datasets:[{data:stats.map(s=>s.var),backgroundColor:"#6ee7b7"}]},
  options:{maintainAspectRatio:false,plugins:{legend:{display:false}}}
 });
}

/* ===== HIST ===== */
function renderHistogram(rows,col){
 const vals=rows.map(r=>+r[col]).filter(x=>!isNaN(x));
 if(charts.hist)charts.hist.destroy();
 charts.hist=new Chart(histChart,{
  type:"bar",
  data:{labels:vals.slice(0,20),datasets:[{data:vals.slice(0,20),backgroundColor:"#60a5fa"}]},
  options:{maintainAspectRatio:false,plugins:{legend:{display:false}}}
 });
}

/* ===== HEATMAP ===== */
function renderHeatmap(rows,cols){
 d3.select("#heatmap").html("");
 const size=18;
 const svg=d3.select("#heatmap").append("svg")
  .attr("width",cols.length*size+120)
  .attr("height",cols.length*size+120);

 const g=svg.append("g").attr("transform","translate(100,80)");
 const color=d3.scaleLinear().domain([-1,0,1]).range(["#002b36","#0b3a59","#2a7f6e"]);

 cols.forEach((c,i)=>{
  cols.forEach((d,j)=>{
   g.append("rect")
    .attr("x",i*size).attr("y",j*size)
    .attr("width",size-1).attr("height",size-1)
    .attr("fill",color(Math.random()*2-1));
  });
 });
}

/* ===== EXPORT ===== */
function exportChart(id){
 const a=document.createElement("a");
 a.href=document.getElementById(id).toDataURL("image/png");
 a.download=id+".png";
 a.click();
}

/* ===== EVENTS ===== */
datasetSelect.onchange=()=>renderAll(datasetSelect.value);
groupSelect.onchange=()=>renderAll(datasetSelect.value);
</script>
</body>
</html>
